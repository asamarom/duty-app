{
  "schemaVersion": "2026.01.tasks-v1",
  "effectId": "01KJF99XAXDJAP5HGE1PXGVH32",
  "taskId": "implement-fix",
  "invocationKey": "fix-equipment-pending-visibility:S000003:implement-fix",
  "stepId": "S000003",
  "kind": "agent",
  "title": "Implement the filtering fix",
  "io": {
    "inputJsonPath": "tasks/01KJF99XAXDJAP5HGE1PXGVH32/input.json",
    "outputJsonPath": "tasks/01KJF99XAXDJAP5HGE1PXGVH32/output.json"
  },
  "inputs": {
    "analyzeBugResult": {
      "currentBehavior": "The Equipment tab displays ALL equipment in the battalion, including equipment with pending transfer status (status='pending_transfer'). When a transfer request is created, the equipment status is set to 'pending_transfer' but the equipment record itself remains in the database with its current assignment. The useEquipment hook queries ALL equipment (line 473: query(collection(db, 'equipment'), orderBy('name'))) without any filtering based on assignment ownership. It then builds rows for each active assignment (lines 138-174), including equipment that has pending transfers. This means a 'מסייעת leader' sees all 5 אלונקה items: 2 that are currently assigned to their unit AND 3 that are assigned elsewhere but have pending transfers - because Firestore rules allow reading equipment in the same battalion (line 186), and the client-side code does not filter by current assignment ownership.",
      "filteringLogicNeeded": "Add filtering after line 193 in useEquipment.tsx rebuild() function: (1) Get user's unitId from useUserBattalion hook, (2) Fetch the user's unit hierarchy (parent/child relationships) to determine which units are under their command, (3) Filter mappedEquipment array to only include items where: assignedType === 'unassigned' OR (assignedType === 'unit' && currentUnitId is in user's unit hierarchy) OR (assignedType === 'individual' && currentPersonnelId belongs to personnel assigned to user's unit hierarchy). The filter should exclude equipment that: (a) has hasPendingTransfer === true AND is not currently assigned to user's unit, (b) is assigned to peer units outside user's command structure. This requires adding unitId/battalionId context to useEquipment and potentially creating a helper function to resolve unit hierarchy ownership.",
      "proposedSolution": "The fix should be applied in useEquipment.tsx at the rebuild() function level (lines 126-193). After building mappedEquipment array, filter it to only include equipment where: (1) assignedType is 'unassigned', OR (2) the assignment belongs to the user's unit hierarchy (currentUnitId matches user's battalion/unit or is a child unit), OR (3) currentPersonnelId belongs to personnel in the user's unit. Alternatively, add a client-side filter in useEquipment that uses the battalionId and user's current unit context from useUserBattalion to filter out equipment assigned to other units. The most efficient approach: modify the rebuild() function to accept battalionId and currentUserUnitId parameters, then filter mappedEquipment to only show items where the assignment's unitId is within the user's unit hierarchy OR the equipment is unassigned. This prevents leaders from seeing equipment assigned to peer units even though they can read those records due to battalion-wide read permissions.",
      "rootCause": "Equipment records are NOT being created for pending transfers - this is correct. The root cause is that useEquipment fetches ALL equipment in the battalion (allowed by Firestore rules line 186) and displays rows for all active assignments without filtering based on whether the current user's unit actually owns those assignments. The pendingQuery (line 475) fetches ALL pending assignment requests in the battalion, and the rebuild() function marks equipment with pending transfers (line 170: hasPendingTransfer: pendingEquipmentIds.has(row.id)), but it still displays them in the Equipment tab. The EquipmentPage.tsx only applies search filtering (lines 47-52), not ownership filtering. There is no logic to filter equipment based on whether it's assigned to the user's unit or personnel under their command."
    },
    "identifyFixResult": {
      "additionalContext": "Need to:\n1. Extract unitId from useUserBattalion hook (line 66: const { battalionId, unitId } = useUserBattalion())\n2. Add state for currentUserPersonnelId: const [currentUserPersonnelId, setCurrentUserPersonnelId] = useState<string | null>(null)\n3. Add useEffect to fetch personnel record:\n   useEffect(() => {\n     if (!user?.uid) return;\n     const q = query(collection(db, 'personnel'), where('userId', '==', user.uid));\n     const unsubscribe = onSnapshot(q, (snap) => {\n       if (snap.docs.length > 0) setCurrentUserPersonnelId(snap.docs[0].id);\n     });\n     return unsubscribe;\n   }, [user?.uid]);\n4. Update rebuild() dependency array to include unitId and currentUserPersonnelId\n5. Apply filter logic before setEquipment()",
      "approach": "Filter mappedEquipment array to show only equipment that is either:\n1. Unassigned (assignmentLevel === 'unassigned')\n2. Assigned to the current user's unit or any parent/child units in the hierarchy\n3. Assigned directly to the current user (currentPersonnelId matches user's personnel record)\n\nThe filter should be applied after line 193 (after mappedEquipment array is fully built) and before line 195 (setEquipment call). This requires:\n\n1. Get current user's unitId from useUserBattalion hook (already available as { unitId })\n2. Get current user's personnelId by querying personnel collection where userId == user.uid\n3. Filter mappedEquipment to include items where:\n   - item.assignmentLevel === 'unassigned' OR\n   - item.currentUnitId === userUnitId OR\n   - item.currentPersonnelId === userPersonnelId\n\nImplementation steps:\n- Add state for currentUserUnitId and currentUserPersonnelId in useEquipment hook\n- Use useUserBattalion to get unitId (already imported at line 27)\n- Add useEffect to fetch personnel record where userId == user.uid to get personnelId\n- Modify rebuild() to apply filter at line 193-195:\n  const filteredEquipment = mappedEquipment.filter(item => \n    item.assignmentLevel === 'unassigned' || \n    item.currentUnitId === userUnitId || \n    item.currentPersonnelId === userPersonnelId\n  );\n  setEquipment(filteredEquipment);",
      "fixLocation": "/home/ubuntu/duty-app/src/hooks/useEquipment.tsx in rebuild() function",
      "lineNumbers": "193-195 (add filtering logic before setEquipment call)",
      "requiresUserContext": true
    }
  }
}
