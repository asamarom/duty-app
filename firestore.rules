rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // NOTE: This function incurs 1 additional read per request that uses it.
    // Consider using Firebase Custom Claims for roles to improve performance.
    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function hasRole(role) {
      return isAuthenticated() &&
        getUserDoc().data.roles != null &&
        role in getUserDoc().data.roles;
    }

    function isAdmin() {
      return hasRole('admin');
    }

    function isLeader() {
      return hasRole('leader');
    }

    function isAdminOrLeader() {
      return isAdmin() || isLeader();
    }

    function hasAnyRole() {
      return isAuthenticated() &&
        getUserDoc().data.roles != null &&
        getUserDoc().data.roles.size() > 0;
    }

    // Get the user's battalion ID by resolving through the units hierarchy.
    // Users are assigned to any unit level (battalion/company/platoon).
    // All unit documents store a battalionId field pointing to their root battalion.
    // We look up the user's unit document to get the correct battalion ID.
    function getUserBattalionId() {
      let userUnitId = getUserDoc().data.unitId;
      let unitDoc = get(/databases/$(database)/documents/units/$(userUnitId));
      return (unitDoc.data != null && unitDoc.data.battalionId != null)
        ? unitDoc.data.battalionId
        : userUnitId;
    }

    // Check if a document belongs to the same battalion as the user
    // MIGRATION: Returns true if battalionId is missing (allows during migration)
    function isSameBattalion(docBattalionId) {
      return docBattalionId == null || getUserBattalionId() == docBattalionId;
    }

    // Check battalion for create operations (battalion ID required on create)
    function isSameBattalionCreate(docBattalionId) {
      return getUserBattalionId() == docBattalionId;
    }

    // Check if user has access to a specific unit (admin or assigned leader)
    function hasUnitAccess(unitId) {
      return isAdmin() ||
        exists(/databases/$(database)/documents/adminUnitAssignments/$(request.auth.uid + '_' + unitId));
    }

    // ============================================================================
    // USERS COLLECTION - User profiles and roles
    // ============================================================================
    match /users/{userId} {
      // Users can read their own doc, admins can read all
      allow read: if isOwner(userId) || isAdmin();

      // Users can create their own doc on signup
      // CRITICAL FIX: Prevent self-assigning roles, validate required fields
      allow create: if isOwner(userId) &&
        !request.resource.data.keys().hasAny(['roles']) &&
        request.resource.data.keys().hasAll(['fullName', 'email', 'createdAt', 'updatedAt']) &&
        request.resource.data.fullName is string &&
        request.resource.data.fullName.size() > 0 &&
        request.resource.data.fullName.size() <= 200 &&
        request.resource.data.email is string &&
        request.resource.data.email.size() > 0;

      // Only admins can update roles
      // MEDIUM FIX: Users can only update whitelisted fields
      allow update: if (isOwner(userId) &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['fullName', 'avatarUrl', 'updatedAt']) &&
        (!request.resource.data.keys().hasAny(['fullName']) ||
          (request.resource.data.fullName is string &&
           request.resource.data.fullName.size() > 0 &&
           request.resource.data.fullName.size() <= 200))) ||
        isAdmin();

      // Only admins can delete users
      allow delete: if isAdmin();
    }

    // ============================================================================
    // UNITS COLLECTION - Organizational hierarchy
    // ============================================================================
    match /units/{unitId} {
      // Units (org structure) are readable by any authenticated user.
      // New users need to read battalions on the signup-request page before a role is assigned.
      allow read: if isAuthenticated();

      // Only admins can create units
      // HIGH FIX: Validate required fields and prevent circular references
      // MIGRATION: battalionId not required during migration
      allow create: if isAdmin() &&
        request.resource.data.keys().hasAll(['name', 'unitType', 'status', 'createdAt', 'updatedAt']) &&
        request.resource.data.name is string &&
        request.resource.data.name.size() > 0 &&
        request.resource.data.name.size() <= 200 &&
        request.resource.data.unitType in ['battalion', 'company', 'platoon'] &&
        request.resource.data.status in ['active', 'inactive', 'deployed'];

      // Only admins can update/delete units
      // HIGH FIX: Prevent circular parent references
      allow update: if isAdmin() &&
        (!request.resource.data.keys().hasAny(['parentId']) ||
          request.resource.data.parentId != unitId) &&
        request.resource.data.unitType in ['battalion', 'company', 'platoon'] &&
        request.resource.data.status in ['active', 'inactive', 'deployed'];

      allow delete: if isAdmin();
    }

    // ============================================================================
    // PERSONNEL COLLECTION - Personnel records
    // ============================================================================
    match /personnel/{personnelId} {
      // CRITICAL FIX: Battalion-based access control
      // Admins can read all, others can only read personnel in their battalion
      allow read: if hasAnyRole() && (isAdmin() || isSameBattalion(resource.data.battalionId));

      // Admins and leaders can create personnel
      // HIGH FIX: Comprehensive field validation
      // MIGRATION: battalionId is optional during migration
      allow create: if isAdminOrLeader() &&
        request.resource.data.keys().hasAll(['serviceNumber', 'rank', 'firstName', 'lastName', 'locationStatus', 'readinessStatus', 'createdAt', 'updatedAt']) &&
        request.resource.data.serviceNumber is string &&
        request.resource.data.serviceNumber.size() > 0 &&
        request.resource.data.serviceNumber.size() <= 50 &&
        request.resource.data.firstName is string &&
        request.resource.data.firstName.size() > 0 &&
        request.resource.data.firstName.size() <= 100 &&
        request.resource.data.lastName is string &&
        request.resource.data.lastName.size() > 0 &&
        request.resource.data.lastName.size() <= 100 &&
        request.resource.data.locationStatus in ['home', 'on_duty', 'off_duty', 'active_mission', 'leave', 'tdy'] &&
        request.resource.data.readinessStatus in ['ready', 'warning', 'critical'] &&
        (isAdmin() || !request.resource.data.keys().hasAny(['battalionId']) || isSameBattalionCreate(request.resource.data.battalionId));

      // Admins and leaders can update personnel
      // CRITICAL FIX: Only admins can modify isSignatureApproved
      // MEDIUM FIX: Validate enum values
      allow update: if isAdminOrLeader() &&
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['isSignatureApproved']) || isAdmin()) &&
        (!request.resource.data.keys().hasAny(['locationStatus']) ||
          request.resource.data.locationStatus in ['home', 'on_duty', 'off_duty', 'active_mission', 'leave', 'tdy']) &&
        (!request.resource.data.keys().hasAny(['readinessStatus']) ||
          request.resource.data.readinessStatus in ['ready', 'warning', 'critical']) &&
        (isAdmin() || isSameBattalion(resource.data.battalionId));

      // Only admins can delete personnel
      allow delete: if isAdmin();
    }

    // ============================================================================
    // EQUIPMENT COLLECTION - Equipment inventory
    // ============================================================================
    match /equipment/{equipmentId} {
      // CRITICAL FIX: Battalion-based access control
      // Admins can read all, others can only read equipment in their battalion
      allow read: if hasAnyRole() && (isAdmin() || isSameBattalion(resource.data.battalionId));

      // Admins and leaders can create equipment
      // HIGH FIX: Validate required fields, positive quantity, valid status
      // MIGRATION: battalionId is optional during migration
      allow create: if isAdminOrLeader() &&
        request.resource.data.keys().hasAll(['name', 'quantity', 'status', 'createdAt', 'updatedAt']) &&
        request.resource.data.name is string &&
        request.resource.data.name.size() > 0 &&
        request.resource.data.name.size() <= 200 &&
        request.resource.data.quantity is int &&
        request.resource.data.quantity > 0 &&
        request.resource.data.status in ['serviceable', 'unserviceable', 'in_maintenance', 'missing', 'pending_transfer'] &&
        (isAdmin() || !request.resource.data.keys().hasAny(['battalionId']) || isSameBattalionCreate(request.resource.data.battalionId));

      // Admins and leaders can update equipment
      // NOTE: Validation that quantity >= assigned quantity requires Cloud Functions
      // as it needs to sum equipmentAssignments, which is too expensive for security rules
      allow update: if isAdminOrLeader() &&
        (!request.resource.data.keys().hasAny(['quantity']) ||
          (request.resource.data.quantity is int && request.resource.data.quantity > 0)) &&
        (!request.resource.data.keys().hasAny(['status']) ||
          request.resource.data.status in ['serviceable', 'unserviceable', 'in_maintenance', 'missing', 'pending_transfer']) &&
        (isAdmin() || isSameBattalion(resource.data.battalionId));

      // Only admins can delete equipment
      allow delete: if isAdmin();
    }

    // ============================================================================
    // EQUIPMENT ASSIGNMENTS COLLECTION - Who has what equipment
    // ============================================================================
    match /equipmentAssignments/{assignmentId} {
      // CRITICAL FIX: Battalion-based access control
      // Admins can read all, others can only read assignments in their battalion
      allow read: if hasAnyRole() && (isAdmin() || isSameBattalion(resource.data.battalionId));

      // Admins and leaders can create assignments
      // HIGH FIX: Validate positive quantity, require either personnelId or unitId
      // MIGRATION: battalionId is optional during migration
      allow create: if isAdminOrLeader() &&
        request.resource.data.keys().hasAll(['equipmentId', 'quantity', 'assignedAt']) &&
        request.resource.data.quantity is int &&
        request.resource.data.quantity > 0 &&
        (request.resource.data.keys().hasAny(['personnelId']) ||
         request.resource.data.keys().hasAny(['unitId'])) &&
        (isAdmin() || !request.resource.data.keys().hasAny(['battalionId']) || isSameBattalionCreate(request.resource.data.battalionId));

      // Admins and leaders can update assignments
      // MEDIUM FIX: returnedAt can only be set, not unset
      allow update: if isAdminOrLeader() &&
        (!resource.data.keys().hasAny(['returnedAt']) ||
         resource.data.returnedAt == null ||
         request.resource.data.returnedAt != null) &&
        (isAdmin() || isSameBattalion(resource.data.battalionId));

      // Admins and leaders can delete assignments
      allow delete: if isAdminOrLeader();
    }

    // ============================================================================
    // ASSIGNMENT REQUESTS COLLECTION - Equipment transfer requests
    // ============================================================================
    match /assignmentRequests/{requestId} {
      // CRITICAL FIX: Battalion-based access control
      // Admins can read all, others can only read requests in their battalion
      allow read: if hasAnyRole() && (isAdmin() || isSameBattalion(resource.data.battalionId));

      // Any authenticated user with a role can create requests
      // CRITICAL FIX: Validate all fields, enforce status='pending', verify requestedBy
      // MIGRATION: battalionId is optional during migration
      allow create: if hasAnyRole() &&
        request.resource.data.keys().hasAll(['equipmentId', 'status', 'requestedAt', 'requestedBy']) &&
        request.resource.data.status == 'pending' &&
        request.resource.data.requestedBy == request.auth.uid &&
        request.resource.data.equipmentId is string &&
        request.resource.data.equipmentId.size() > 0 &&
        // quantity is optional; when present it must be a positive integer (bulk transfer quantity)
        (!request.resource.data.keys().hasAny(['quantity']) || (request.resource.data.quantity is int && request.resource.data.quantity > 0)) &&
        (isAdmin() || !request.resource.data.keys().hasAny(['battalionId']) || isSameBattalionCreate(request.resource.data.battalionId));

      // Only admins and leaders can update requests (approve/reject)
      // HIGH FIX: Validate status transitions (pending â†’ approved/rejected only)
      allow update: if isAdminOrLeader() &&
        resource.data.status == 'pending' &&
        request.resource.data.status in ['approved', 'rejected'] &&
        (isAdmin() || isSameBattalion(resource.data.battalionId));

      // Only admins can delete requests
      allow delete: if isAdmin();
    }

    // ============================================================================
    // SIGNUP REQUESTS COLLECTION - New user registration requests
    // ============================================================================
    match /signupRequests/{requestId} {
      // Users can read their own requests, admins can read all
      allow read: if (isAuthenticated() && resource.data.userId == request.auth.uid) || isAdmin();

      // Authenticated users can create their own signup request
      // CRITICAL FIX: Comprehensive field validation, enforce status='pending'
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.keys().hasAll(['userId', 'fullName', 'email', 'serviceNumber', 'status', 'createdAt']) &&
        request.resource.data.status == 'pending' &&
        request.resource.data.serviceNumber is string &&
        request.resource.data.serviceNumber.size() > 0 &&
        request.resource.data.serviceNumber.size() <= 50 &&
        request.resource.data.fullName is string &&
        request.resource.data.fullName.size() > 0 &&
        request.resource.data.fullName.size() <= 200 &&
        request.resource.data.email is string &&
        request.resource.data.email.size() > 0;

      // Only admins can update (approve/decline) signup requests
      // HIGH FIX: Validate status transitions
      allow update: if isAdmin() &&
        request.resource.data.status in ['pending', 'approved', 'declined'] &&
        resource.data.status == 'pending' &&
        request.resource.data.status in ['approved', 'declined'];

      // Only admins can delete signup requests
      allow delete: if isAdmin();
    }

    // ============================================================================
    // ADMIN UNIT ASSIGNMENTS COLLECTION - Leader unit access control
    // ============================================================================
    match /adminUnitAssignments/{assignmentId} {
      // Admins can read all, leaders can read their own
      allow read: if isAdmin() ||
        (isLeader() && resource.data.userId == request.auth.uid);

      // Only admins can create/update/delete unit assignments
      allow create, update, delete: if isAdmin();
    }
  }
}
